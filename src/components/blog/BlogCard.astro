---
import { Image } from 'astro:assets';
import { formatDate } from '@/lib/formatDate';
import { getBentoGridSpan } from '@/lib/blog-utils';
import { calculateImageDimensions } from '@/lib/image-dimensions';
import type { PostSource } from '@/types/blog';

interface Props {
  post: any; // BlogPost type from content collection
  index?: number; // Index for bento grid pattern
}

const { post, index = 0 } = Astro.props;
const { data } = post;

// Fallback for missing cover image
const hasCoverImage = data.coverImage?.url;

// Get bento grid span classes
const { desktop, aspectClass, aspectRatio, height } = getBentoGridSpan(index);

// Calculate responsive dimensions
const dimensions = calculateImageDimensions(aspectRatio, index);

// Determine if this is an external post (freeCodeCamp)
const source: PostSource = data.source || 'hashnode';
const isExternal = source === 'freecodecamp' && data.externalUrl;
const postUrl = isExternal ? data.externalUrl : `/blog/${data.slug}`;
const linkProps = isExternal ? { target: '_blank', rel: 'noopener noreferrer' } : {};
---

<article class={`group relative overflow-hidden rounded-lg brutalist-card-hover sm:col-span-2 lg:${desktop}`}>
  <a href={postUrl} class='block' {...linkProps}>
    {
      hasCoverImage ? (
        <div class={`relative w-full overflow-hidden ${aspectClass} ${height}`}>
          <div class='absolute inset-0 animate-pulse bg-gray-200' />

          <Image
            src={data.coverImage.url}
            alt={data.coverImage.alt || data.title}
            width={dimensions.mobile.width}
            height={dimensions.mobile.height}
            class='h-full w-full object-cover transition-all duration-500 group-hover:scale-105'
            style='opacity: 0; animation: fadeIn 0.5s ease-in forwards;'
            loading='lazy'
          />
        </div>
      ) : (
        <div
          class={`flex items-center justify-center bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 ${aspectClass} ${height}`}
        >
          <span class='text-6xl'>üìù</span>
        </div>
      )
    }

    <div class='p-6'>
      <div class='mb-2 flex items-center justify-between'>
        <h2 class='font-display line-clamp-2 text-lg font-bold text-gray-900 sm:text-xl'>
          {data.title}
        </h2>
        {
          isExternal && (
            <span class='ml-2 flex-shrink-0 rounded bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-800'>
              freeCodeCamp
            </span>
          )
        }
      </div>

      <div class='mb-3 flex items-center gap-4 font-sans text-xs text-gray-600 sm:text-sm'>
        <time datetime={data.publishedAt.toISOString()}>
          {formatDate(data.publishedAt)}
        </time>
        <span>{data.readingTime} min read</span>
        {
          isExternal && (
            <span class='flex items-center gap-1'>
              <svg
                xmlns='http://www.w3.org/2000/svg'
                class='h-3 w-3'
                fill='none'
                viewBox='0 0 24 24'
                stroke='currentColor'
              >
                <path
                  stroke-linecap='round'
                  stroke-linejoin='round'
                  stroke-width='2'
                  d='M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14'
                />
              </svg>
            </span>
          )
        }
      </div>

      <p class='mb-4 line-clamp-3 font-sans text-sm text-gray-700 sm:text-base'>
        {data.brief}
      </p>

      {
        data.tags && data.tags.length > 0 && (
          <div class='flex flex-wrap gap-2'>
            {data.tags.slice(0, 3).map((tag: any) => (
              <span class='inline-block rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-700'>
                {tag.name}
              </span>
            ))}
          </div>
        )
      }
    </div>
  </a>
</article>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>
