---
import { getCollection } from 'astro:content';
import MainLayout from '@/layouts/main-layout.astro';
import BlogSearch from '@/components/blog/BlogSearch';
import BentoGrid from '@/components/blog/BentoGrid';
import { Social } from '@/components/social';
import { cn } from '@/lib/utils';
import type { LightweightPost } from '@/types/blog';

// Fetch all blog posts and sort by date (newest first)
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()
);

// Create lightweight posts for better performance (reduces serialization overhead)
const lightweightPosts: LightweightPost[] = sortedPosts.map((post) => ({
  id: post.id,
  data: {
    slug: post.data.slug,
    title: post.data.title,
    brief: post.data.brief,
    coverImage: post.data.coverImage,
    tags: post.data.tags,
    publishedAt: post.data.publishedAt,
    readingTime: post.data.readingTime
  }
}));
---

<MainLayout pageTitle='Blog' pageDescription='Read articles about web development, programming, and technology'>
  <Fragment slot='head'>
    <!-- DNS prefetch and preconnect for Hashnode CDN to speed up image loading -->
    <link rel='dns-prefetch' href='https://cdn.hashnode.com' />
    <link rel='preconnect' href='https://cdn.hashnode.com' crossorigin />
  </Fragment>
  <section class={cn('mb-2')}>
    <div class={cn('prose prose-lg prose-slate max-w-none')}>
      <h1 class={cn('py-4 text-center text-display-md text-slate-800')}>Blog</h1>
    </div>
  </section>
  <section class={cn('mb-12')}>
    <p class={cn('pb-6 text-center text-base sm:text-lg text-slate-600')}>
      Thoughts on web development, technology, and more
    </p>

    {
      lightweightPosts.length === 0 ? (
        <div class={cn('mx-auto max-w-md rounded-lg border-2 border-dashed border-slate-300 p-12 text-center')}>
          <p class={cn('text-base text-slate-600 sm:text-lg')}>No blog posts yet. Check back soon!</p>
        </div>
      ) : (
        <>
          <BlogSearch posts={lightweightPosts} client:idle />

          <BentoGrid posts={lightweightPosts} initialCount={6} postsPerLoad={3} client:visible />
        </>
      )
    }
  </section>
  <section class='pt-4 pb-8'>
    <div class={cn('prose prose-lg prose-slate mx-auto mt-12 max-w-3xl')}>
      <h3 class={cn('mb-4 text-center font-bold text-slate-700')}>Elsewhere on the internet</h3>
      <Social />
    </div>
  </section>
</MainLayout>
