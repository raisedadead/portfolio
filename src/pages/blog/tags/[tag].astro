---
// Dynamic tag page - shows posts filtered by a specific tag
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import MainLayout from '@/layouts/main-layout.astro';
import BlogSearch from '@/components/blog/BlogSearch';
import BentoGrid from '@/components/blog/BentoGrid';
import { Social } from '@/components/social';
import { getAllTags, filterPostsByTag } from '@/lib/blog-utils';
import { cn } from '@/lib/utils';
import type { LightweightPost } from '@/types/blog';

export const getStaticPaths = (async () => {
  const hashnodePosts = await getCollection('blog');
  const freecodecampPosts = await getCollection('freecodecamp');

  // Normalize Hashnode posts
  const normalizedHashnodePosts: LightweightPost[] = hashnodePosts.map((post) => ({
    id: post.id,
    data: {
      slug: post.data.slug,
      title: post.data.title,
      brief: post.data.brief,
      coverImage: post.data.coverImage,
      tags: post.data.tags,
      publishedAt: post.data.publishedAt,
      readingTime: post.data.readingTime,
      source: 'hashnode' as const
    }
  }));

  // Normalize freeCodeCamp posts
  const normalizedFccPosts: LightweightPost[] = freecodecampPosts.map((post) => {
    const urlPath = post.data.url || '';
    const slug = urlPath.split('/').filter(Boolean).pop() || post.id;
    const mediaImage = post.data.media?.[0]?.url;
    const imageData = post.data.image;
    const coverImageUrl = mediaImage || imageData?.url;
    const tags =
      post.data.categories?.map((cat: { label: string; term: string }) => ({
        name: cat.label,
        slug: cat.term.toLowerCase().replace(/\s+/g, '-')
      })) || [];
    const content = post.data.content || post.data.description || '';
    const wordCount = content.split(/\s+/).length;
    const readingTime = Math.max(1, Math.ceil(wordCount / 200));

    return {
      id: `fcc-${post.id}`,
      data: {
        slug,
        title: post.data.title || 'Untitled',
        brief: post.data.description || '',
        coverImage: coverImageUrl ? { url: coverImageUrl } : undefined,
        tags,
        publishedAt: post.data.published || new Date(),
        readingTime,
        source: 'freecodecamp' as const,
        externalUrl: post.data.url || undefined
      }
    };
  });

  // Merge all posts
  const allPosts = [...normalizedHashnodePosts, ...normalizedFccPosts];
  const allTags = getAllTags(allPosts);

  return allTags.map((tag) => {
    const filteredPosts = filterPostsByTag(allPosts, tag.slug);
    return {
      params: { tag: tag.slug },
      props: {
        tag,
        posts: filteredPosts,
        allPosts
      }
    };
  });
}) satisfies GetStaticPaths;

const { tag, posts, allPosts } = Astro.props;

// Sort posts by date (newest first)
const sortedPosts = posts.sort(
  (a: LightweightPost, b: LightweightPost) =>
    new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()
);

// SEO metadata
const pageTitle = `${tag.name} Posts`;
const pageDescription = `Browse all blog posts tagged with ${tag.name}`;
const canonicalURL = new URL(`/blog/tags/${tag.slug}`, Astro.site).toString();

// Structured data for tag page
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: pageTitle,
  description: pageDescription,
  url: canonicalURL,
  numberOfItems: posts.length,
  hasPart: posts.map((post) => ({
    '@type': 'BlogPosting',
    headline: post.data.title,
    datePublished: post.data.publishedAt,
    url: new URL(`/blog/${post.data.slug}`, Astro.site).toString()
  }))
};
---

<MainLayout
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  pageUrl={canonicalURL}
  pageImage={posts[0]?.data.coverImage?.url}
>
  <script type='application/ld+json' is:inline set:html={JSON.stringify(structuredData)} />
  <section class={cn('mb-2')}>
    <div class={cn('prose prose-lg prose-slate max-w-none')}>
      <h1 class={cn('py-4 text-center text-display-md text-slate-800')}>
        Posts tagged with "{tag.name}"
      </h1>
    </div>
  </section>

  <section class={cn('mb-12')}>
    <div class={cn('mb-6 text-center')}>
      <p class={cn('text-base sm:text-lg text-slate-600')}>
        {sortedPosts.length}
        {sortedPosts.length === 1 ? 'post' : 'posts'} found
      </p>
    </div>

    {
      sortedPosts.length === 0 ? (
        <div class={cn('mx-auto max-w-md rounded-lg border-2 border-dashed border-slate-300 p-12 text-center')}>
          <p class={cn('text-base text-slate-600 sm:text-lg')}>No posts found with this tag.</p>
        </div>
      ) : (
        <>
          <BlogSearch posts={allPosts} client:idle />

          <BentoGrid posts={sortedPosts} initialCount={6} postsPerLoad={3} client:visible />

          {/* View All Tags Button */}
          <div class='flex justify-center py-8'>
            <a
              href='/blog/tags'
              class='brutalist-button-secondary inline-flex h-14 items-center justify-center gap-2 px-6 py-3 text-sm font-bold sm:text-base md:text-lg'
              aria-label='View all tags'
            >
              <span aria-hidden='true'>‚Üê</span>
              <span>View all tags</span>
            </a>
          </div>
        </>
      )
    }
  </section>
  <section class='pt-4 pb-8'>
    <div class={cn('prose prose-lg prose-slate mx-auto mt-12 max-w-3xl')}>
      <h3 class={cn('mb-4 text-center font-bold text-slate-700')}>Elsewhere on the internet</h3>
      <Social />
    </div>
  </section>
</MainLayout>
