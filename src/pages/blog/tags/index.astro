---
// Tags index page - lists all unique tags from blog posts
import { getCollection } from 'astro:content';
import MainLayout from '@/layouts/main-layout.astro';
import TagCard from '@/components/blog/TagCard';
import { Social } from '@/components/social';
import { getTagsWithCount } from '@/lib/blog-utils';
import { cn } from '@/lib/utils';
import type { LightweightPost } from '@/types/blog';

// Fetch posts from both collections
const hashnodePosts = await getCollection('blog');
const freecodecampPosts = await getCollection('freecodecamp');

// Normalize Hashnode posts
const normalizedHashnodePosts: LightweightPost[] = hashnodePosts.map((post) => ({
  id: post.id,
  data: {
    slug: post.data.slug,
    title: post.data.title,
    brief: post.data.brief,
    coverImage: post.data.coverImage,
    tags: post.data.tags,
    publishedAt: post.data.publishedAt,
    readingTime: post.data.readingTime,
    source: 'hashnode' as const
  }
}));

// Normalize freeCodeCamp posts
const normalizedFccPosts: LightweightPost[] = freecodecampPosts.map((post) => {
  const urlPath = post.data.url || '';
  const slug = urlPath.split('/').filter(Boolean).pop() || post.id;
  const mediaImage = post.data.media?.[0]?.url;
  const imageData = post.data.image;
  const coverImageUrl = mediaImage || imageData?.url;
  const tags =
    post.data.categories?.map((cat: { label: string; term: string }) => ({
      name: cat.label,
      slug: cat.term.toLowerCase().replace(/\s+/g, '-')
    })) || [];
  const content = post.data.content || post.data.description || '';
  const wordCount = content.split(/\s+/).length;
  const readingTime = Math.max(1, Math.ceil(wordCount / 200));

  return {
    id: `fcc-${post.id}`,
    data: {
      slug,
      title: post.data.title || 'Untitled',
      brief: post.data.description || '',
      coverImage: coverImageUrl ? { url: coverImageUrl } : undefined,
      tags,
      publishedAt: post.data.published || new Date(),
      readingTime,
      source: 'freecodecamp' as const,
      externalUrl: post.data.url || undefined
    }
  };
});

// Merge all posts and extract unique tags with counts
const allPosts = [...normalizedHashnodePosts, ...normalizedFccPosts];
const tagsWithCount = getTagsWithCount(allPosts);

// SEO metadata
const canonicalURL = new URL('/blog/tags', Astro.site).toString();

// Structured data for tags index
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: 'Blog Tags',
  description: 'Browse all blog posts organized by tags',
  url: canonicalURL,
  numberOfItems: tagsWithCount.length,
  itemListElement: tagsWithCount.map((tag, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    url: new URL(`/blog/tags/${tag.slug}`, Astro.site).toString(),
    name: tag.name,
    description: `${tag.count} ${tag.count === 1 ? 'post' : 'posts'} about ${tag.name}`
  }))
};
---

<MainLayout pageTitle='Blog Tags' pageDescription='Browse all blog posts organized by tags' pageUrl={canonicalURL}>
  <script type='application/ld+json' is:inline set:html={JSON.stringify(structuredData)} />
  <section class={cn('mb-2')}>
    <div class={cn('prose prose-lg prose-slate max-w-none')}>
      <h1 class={cn('py-4 text-center text-display-md text-slate-800')}>Blog Tags</h1>
    </div>
  </section>

  <section class={cn('mb-12')}>
    <p class={cn('pb-6 text-center text-base sm:text-lg text-slate-600')}>Browse posts by topic</p>

    {
      tagsWithCount.length === 0 ? (
        <div class={cn('mx-auto max-w-md rounded-lg border-2 border-dashed border-slate-300 p-12 text-center')}>
          <p class={cn('text-base text-slate-600 sm:text-lg')}>No tags found yet. Check back soon!</p>
        </div>
      ) : (
        <div class={cn('grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3')}>
          {tagsWithCount.map((tag) => (
            <TagCard name={tag.name} slug={tag.slug} count={tag.count} />
          ))}
        </div>
      )
    }
    <div class='flex justify-center py-8'>
      <a
        href='/blog'
        class='brutalist-button-secondary inline-flex h-14 items-center justify-center gap-2 px-6 py-3 text-sm font-bold sm:text-base md:text-lg'
        aria-label='Back to blog'
      >
        <span aria-hidden='true'>‚Üê</span>
        <span>Back to blog</span>
      </a>
    </div>
  </section>
  <section class='pt-4 pb-8'>
    <div class={cn('prose prose-lg prose-slate mx-auto mt-12 max-w-3xl')}>
      <h3 class={cn('mb-4 text-center font-bold text-slate-700')}>Elsewhere on the internet</h3>
      <Social />
    </div>
  </section>
</MainLayout>
